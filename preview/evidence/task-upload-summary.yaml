---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: evidence-upload-summary
  labels:
    tekton.dev/deprecated: true
spec:
  params:
    - name: evidence-repo-path
      description: path of the evidence repo
      default: "."
    - name: evidence-summary-path
      description: path of the evidence summary to upload
    - name: retry-count
      description: retry count to pull and push git evidence repo
      default: "5"
    - name: pipeline-debug
      description: pipeline debug mode
      default: "0"

  workspaces:
    - name: evidence-locker

  stepTemplate:
    env:
      - name: PIPELINE_DEBUG
        value: $(params.pipeline-debug)
      - name: PIPELINE_RUN_ID
        valueFrom:
          fieldRef:
            fieldPath: metadata.annotations['devops.cloud.ibm.com/tekton-pipeline']

  steps:
    - name: push-summary-to-locker
      image: ibmcom/pipeline-base-image:2.6
      workingDir: $(workspaces.evidence-locker.path)/$(params.evidence-repo-path)/
      script: |
          #!/bin/bash

          set -e -o pipefail
          if [ "$PIPELINE_DEBUG" == 1 ]; then
            pwd
            env
            trap env EXIT
            set -x
          fi

          git config --global user.email "tekton@example.com"
          git config --global user.name "Tekton"

          git add "$(params.evidence-summary-path)"
          git commit -q -m "upload evidence summary for $PIPELINE_RUN_ID"

          retries="$(params.retry-count)"

          i=1
          while [ $i -le $retries ]
          do
              if git push -q; then
                  break
              else
                git pull -q
                sleep 1
              fi
              i=$(( $i + 1 ))

              if [ $i -gt $retries ]; then
                echo "Could not add $(params.evidence-summary-path) to the evidence-locker repository!"
                exit 1
              else
                echo "Retrying to push summary (try $i)..."
              fi
          done

          echo "The following summary was pushed to the evidence locker repository:"
          jq . "$(params.evidence-summary-path)"
